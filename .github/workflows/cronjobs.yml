---
name: Cron Jobs

######################################################################
## minute         0-59
## hour           0-23
## day of month   1-31
## month          1-12
## day of week    0-7
######################################################################

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: 0 0 1 * * # every month on the first day of the month at midnight
  # Run workflow manually (without waiting for the cron to be called),
  # through the Github Actions Workflow page directly.
  workflow_dispatch:

jobs:
  cronjobs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache gems
        uses: actions/cache@v4.2.0
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gem-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: ${{ runner.os }}-gem-

      - run: pip install pre-commit
        shell: bash

      - run: pre-commit autoupdate
        shell: bash

      - uses: peter-evans/create-pull-request@v7.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update/pre-commit-hooks
          title: Update pre-commit hooks
          commit-message: Auto-update pre-commit hooks
          body: Update versions of pre-commit hooks to latest version.

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Build with Jekyll
        # Outputs to the './_site' directory by default
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: Check HTML
        uses: chabad360/htmlproofer@v2
        timeout-minutes: 30
        with:
          # The directory to scan.
          directory: ./_site
          # The arguments to pass to HTMLProofer.
          # Unsure how to enable alt tags for teaser images.
          # Treat urls with this domain as internal urls.
          # Keep in sync with bin/build.sh and .github/workflows/pull-requests-and-pushes.yml
          # yamllint disable
          arguments:
            "--no-enforce-https --ignore-empty-alt --ignore-status-codes 401,403,429 --only-4xx\
            \ --typhoeus '{ \"connecttimeout\": 30, \"timeout\": 30 }'\
            \ --ignore-urls \"#,/4kib.com/,/archive.org/,/askubuntu.com/,/doi.org/,/enki.com/,/enkipro.com/,/help.github.com/,/mademistakes.com/,/medium.com/,/proinsias.github.io/,/serverfault.com/,/stackexchange.com/,/stackoverflow.com/,/towardsdatascience.com/,/twitter.com/\""
            # yamllint enable
